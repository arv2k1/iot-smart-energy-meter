<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- BS5 css -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.0.2/css/bootstrap.min.css"
      integrity="sha512-usVBAd66/NpVNfBge19gws2j6JZinnca12rAe2l+d+QkLU9fiG02O1X8Q6hepIpr/EYKZvKx/I9WsnujJuOmBA=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />

    <title>IoT Smart Energy Meter</title>

    <style>
      body {
        /* required by scrollspy */
        position: relative;
      }

      .cards {
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
      }

      .card {
        outline: 0;
        border: 0;
        border-radius: 1em;
      }

      @media (max-width: 768px) {
        .card {
          flex: 0 1 48%;
        }
        .cards {
          justify-content: space-between;
        }

        .sm-full-width-card {
          min-width: 100%;
        }
      }

      .card p {
        color: #a5aaad;
        font-size: 18px;
        font-weight: 500;
      }

      .card span {
        font-weight: 700;
        color: #2e4a66;
      }
    </style>
  </head>

  <body>
    <!-- Navbar -->
    <nav
      id="navbar"
      class="
        navbar
        sticky-top
        navbar-expand-md navbar-dark
        bg-dark
        shadow-sm
        px-md-3
      "
    >
      <div class="container">
        <!-- Navbar collapse button -->
        <button
          class="navbar-toggler"
          type="button"
          style="outline: none; box-shadow: none; border: 0"
          data-bs-toggle="collapse"
          data-bs-target="#collapsibleNavbar"
        >
          <span class="navbar-toggler-icon"></span>
        </button>

        <!-- Navbar brand -->
        <a class="navbar-brand me-auto" href="#"> IoT Smart Energy Meter </a>

        <!-- Navbar links  -->
        <div
          class="collapse navbar-collapse justify-content-end"
          id="collapsibleNavbar"
        >
          <ul id="mainNav" class="navbar-nav ms-auto">
            <li class="nav-item">
              <a class="nav-link scrollto" href="#liveData">
                &nbsp &nbsp Monitor Live data
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link scrollto" href="#viewMetrics">
                &nbsp &nbsp View Metrics
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link scrollto" href="#preferences">
                &nbsp &nbsp Preferences
              </a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- Background color wrapper for container -->
    <div style="background-color: rgb(0, 0, 0, 0.05)">
      <!-- main container start -->
      <div class="container py-3">
        <!-- Monitor liveData section -->
        <section id="liveData" class="mb-3">
          <div><h3 class="ps-2">Meter Readings</h3></div>
          <div class="cards p-2">
            <!-- Card 1 - Estimated Bill Amount -->
            <div class="card shadow mb-3 sm-full-width-card">
              <div
                class="
                  card-body
                  d-flex
                  flex-column
                  bd-highlight
                  align-items-center
                  justify-content-around
                "
              >
                <div style="white-space: nowrap">
                  <span class="h2" id="billUnit">&#8377;</span>
                  <span class="h2" id="billValue"></span>
                </div>
                <div><p>Estimated Bill</p></div>
              </div>
            </div>

            <!-- Card 2 - Power -->
            <div class="card shadow mb-3">
              <div
                class="
                  card-body
                  d-flex
                  flex-column
                  bd-highlight
                  align-items-center
                  justify-content-around
                "
              >
                <div style="white-space: nowrap">
                  <span class="h2" id="powerValue"></span>
                  <span class="h2" id="powerUnit">W</span>
                </div>
                <div><p>Power</p></div>
              </div>
            </div>

            <!-- Card 3 - Energy -->
            <div class="card shadow mb-3">
              <div
                class="
                  card-body
                  d-flex
                  flex-column
                  bd-highlight
                  align-items-center
                  justify-content-around
                "
              >
                <div style="white-space: nowrap">
                  <span class="h2" id="energyValue"></span>
                  <span class="h2" id="energyUnit">kWh</span>
                </div>
                <div>
                  <p>Energy</p>
                </div>
              </div>
            </div>

            <!-- Card 4 - Voltage -->
            <div class="card shadow mb-3">
              <div
                class="
                  card-body
                  d-flex
                  flex-column
                  bd-highlight
                  align-items-center
                  justify-content-around
                "
              >
                <div style="white-space: nowrap">
                  <span class="h2" id="voltageValue"></span>
                  <span class="h2" id="voltageUnit">V</span>
                </div>
                <div>
                  <p>Voltage</p>
                </div>
              </div>
            </div>

            <!-- Card 5 - Current -->
            <div class="card shadow mb-3">
              <div
                class="
                  card-body
                  d-flex
                  flex-column
                  bd-highlight
                  align-items-center
                  justify-content-around
                "
              >
                <div style="white-space: nowrap">
                  <span class="h2" id="currentValue"></span>
                  <span class="h2" id="currentUnit">A</span>
                </div>
                <div>
                  <p>Current</p>
                </div>
              </div>
            </div>

            <!-- Card 6 - Power Factor -->
            <div class="card shadow mb-3">
              <div
                class="
                  card-body
                  d-flex
                  flex-column
                  bd-highlight
                  align-items-center
                  justify-content-around
                "
              >
                <div style="white-space: nowrap">
                  <span class="h2" id="pfValue"></span>
                </div>
                <div>
                  <p>Power factor</p>
                </div>
              </div>
            </div>

            <!-- Card 7 - Frequency -->
            <div class="card shadow mb-3">
              <div
                class="
                  card-body
                  d-flex
                  flex-column
                  bd-highlight
                  align-items-center
                  justify-content-around
                "
              >
                <div style="white-space: nowrap">
                  <span class="h2" id="frequencyValue"></span>
                  <span class="h2" id="frequencyUnit">Hz</span>
                </div>
                <div>
                  <p>Frequency</p>
                </div>
              </div>
            </div>
          </div>
          <!-- End of cards row  -->
        </section>
        <!-- End of liveData section -->

        <!-- View Metrics section -->
        <section id="viewMetrics" class="mb-3">
          <div><h3 class="ps-2">Metrics</h3></div>
          <h5 class="ps-2" style="text-align: center">Power</h5>
          <div id="powerChart"></div>
          <h5 class="ps-2" style="text-align: center">Energy</h5>
          <div id="energyChart"></div>
        </section>
        <!-- End of viewMetrics section -->

        <!-- Preferences section -->
        <section id="preferences" class="mb-3">
          <div><h3 class="ps-2 mb-3">Preferences</h3></div>
          <div class="ps-2">
            <!-- Email -->
            <div class="mb-3">
              <input
                type="email"
                class="form-control"
                id="email-id"
                placeholder="Email id to receive usage alerts"
              />
            </div>
            <!-- Daily limit -->
            <div class="mb-3">
              <input
                type="number"
                class="form-control"
                id="limit"
                placeholder="Desired Monthly bill to calculate daily limits"
              />
            </div>
            <!-- Save button -->
            <div class="d-flex justify-content-center">
              <button class="btn btn-primary me-2" type="button">
                &nbsp; &nbsp; Save &nbsp; &nbsp;
              </button>
            </div>
          </div>
        </section>
        <!-- End of preferences section -->
      </div>
    </div>

    <!-- jquery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <!-- BS5 js -->
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.0.2/js/bootstrap.bundle.min.js"
      integrity="sha512-72WD92hLs7T5FAXn3vkNZflWG6pglUDDpm87TeQmfSg8KnrymL2G30R7as4FmTwhgu9H7eSzDCX3mjitSecKnw=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>

    <!-- Apex Charts -->
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

    <!-- Init Components -->
    <script>
      // Init Scrollspy
      $(() => {
        var scrollSpy = new bootstrap.ScrollSpy(document.body, {
          target: "#mainNav",
          offset: 200,
        });
      });
    </script>

    <!-- Power Chart -->
    <script>
      let powerData = [];

      const getPowerChartData = (latestPower) => {
        let d = new Date();
        let date = ""; // `${d.getHours()}:${d.getMinutes()}:${d.getSeconds()}`;
        let latestObj = {
          x: date,
          y: latestPower,
        };
        powerData.push(latestObj);
        if (powerData.length > 60) {
          powerData.splice(0, 1);
        }
        return powerData;
      };

      let powerChartOptions = {
        chart: {
          type: "area",
          height: 250,
        },
        dataLabels: {
          enabled: false,
        },
        series: [],
        xaxis: {
          type: "category",
        },
        stroke: {
          curve: "smooth",
        },
      };

      const powerChart = new ApexCharts(
        document.querySelector("#powerChart"),
        powerChartOptions
      );

      powerChart.render();

      const updatePowerChart = (latestPower) => {
        powerChart.updateSeries([
          {
            name: "power",
            data: getPowerChartData(latestPower),
          },
        ]);
      };
    </script>

    <!-- Energy chart -->
    <script>
      const getEnergyData = () => {
        let arr = [230, 255, 220, 270, 240];
        const cur = $("#energyValue").text();
        console.log(cur);
        arr.push(150);
        return arr;
      };

      let energyChartOptions = {
        chart: {
          type: "bar",
          height: 250,
        },
        dataLabels: {
          enabled: false,
        },
        series: [
          {
            name: "energy",
            data: getEnergyData(),
          },
        ],
        xaxis: {
          categories: [
            "SEP - OCT",
            "NOV - DEC",
            "JAN - FEB",
            "MAR - APR",
            "MAY - JUN",
            "JUL - AUG",
          ],
        },
        stroke: {
          curve: "smooth",
        },
      };

      const energyChart = new ApexCharts(
        document.querySelector("#energyChart"),
        energyChartOptions
      );

      energyChart.render();
    </script>

    <!-- Code for meter readings Update -->
    <script>
      const updateReadings = () => {
        $.getJSON(
          "https://sheets.googleapis.com/v4/spreadsheets/1FAJIonMEJuFqgoAJkBlD7iUobrcCxxZjVH3vte7-I48/values/B2%3AB8?key=AIzaSyCNNTlGLjbAVl1rWmP_hfw8xEA2YWTf7zw",
          (resp) => changeValues(resp.values)
        );
      };

      const changeValues = (arr) => {
        // arr -> 2d array : 7 rows, 1 column
        $("#voltageValue").text(arr[0][0]);
        $("#currentValue").text(arr[1][0]);
        $("#frequencyValue").text(arr[2][0]);
        $("#pfValue").text(arr[3][0]);

        let pow = parseFloat(arr[4][0]);
        pow = pow < 1 ? 0 : pow;
        $("#powerValue").text(pow);

        let egy = parseFloat(arr[5][0]) + parseFloat(arr[6][0]);
        $("#energyValue").text(egy.toFixed(2));

        $("#billValue").text(calculateBill(egy).toFixed(2));

        updatePowerChart(pow);
      };

      const calculateBill = (energy) => {
        // TNEB Tariff rates for domestic consumer
        // Source : https://www.tangedco.gov.in/linkpdf/ONE_PAGE_STATEMENT.pdf
        // 0 to 100   : Rs.0 per unit
        // 101 to 200 : Rs.3.50 per unit
        // 201 to 500 : Rs.4.60 per unit
        // above 500  : Rs.6.60 per unit

        if (energy <= 100) return 0;

        if (energy <= 200) return (energy - 100) * 3.5;

        if (energy <= 500) return 0 + 100 * 3.5 + (energy - 200) * 4.6;

        return 0 + 100 * 3.5 + 300 * 4.6 + (energy - 500) * 6.6;
      };

      setInterval(updateReadings, 4 * 1000);
      // $(() => updateReadings());
    </script>

    <script>
      function clear() {
        $("#email-id").val("");
        $("#limit").val("");
      }
      $(".btn").on("click", clear);
    </script>
  </body>
</html>
